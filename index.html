<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RBI System | SEC JERICK</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="theme-color" content="#0f172a">
    <meta name="application-name" content="RBI System">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

    <script>
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js').catch(err => console.log('SW Fail', err));
      }
    </script>

    <style>
        /* --- MODERN DESIGN VARIABLES --- */
        :root {
            --primary: #0f172a;       /* Slate 900 */
            --accent: #3b82f6;        /* Blue 500 */
            --accent-hover: #2563eb;  /* Blue 600 */
            --bg: #f1f5f9;            /* Slate 100 */
            --card: #ffffff;
            --text-main: #334155;     /* Slate 700 */
            --text-light: #64748b;    /* Slate 500 */
            --danger: #ef4444;        /* Red 500 */
            --success: #22c55e;       /* Green 500 */
            --warning: #f59e0b;       /* Amber 500 */
        }

        *, *::before, *::after { box-sizing: border-box; }
        html, body { margin: 0; padding: 0; height: 100%; }
        body { font-family: 'Inter', 'Segoe UI', sans-serif; background: var(--bg); color: var(--text-main); -webkit-tap-highlight-color: transparent; }

        /* --- GLOBAL PUROK CONTEXT BAR --- */
        .context-bar {
            background: var(--primary);
            color: white;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 900;
        }
        .context-info h4 { margin: 0; font-size: 16px; font-weight: 700; letter-spacing: 0.5px; }
        .context-info small { opacity: 0.7; font-size: 11px; }
        
        .purok-selector-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .purok-selector-btn:active { background: rgba(255,255,255,0.2); transform: scale(0.98); }
        .purok-badge { background: var(--warning); color: #000; padding: 2px 8px; border-radius: 10px; font-weight: 800; font-size: 12px; }

        /* --- LAYOUT & TABS --- */
        .app-container { max-width: 600px; margin: 0 auto; padding-bottom: 60px; }

        .tab-nav { display: flex; background: white; border-bottom: 1px solid #e2e8f0; position: sticky; top: 60px; z-index: 800; overflow-x: auto; }
        .tab-btn {
            flex: 1; border: none; background: none; padding: 15px;
            font-size: 12px; font-weight: 600; color: var(--text-light);
            cursor: pointer; border-bottom: 3px solid transparent; transition: 0.2s; white-space: nowrap;
        }
        .tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); }
        .tab-btn i { margin-right: 5px; }

        .content-area { padding: 20px; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- FORM ELEMENTS --- */
        .card-section {
            background: var(--card);
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            margin-bottom: 20px;
        }
        .section-title {
            color: var(--primary); font-size: 15px; font-weight: 700;
            border-left: 4px solid var(--accent); padding-left: 10px; margin: 0 0 15px 0;
            text-transform: uppercase;
        }

        .form-group { margin-bottom: 15px; position: relative; }
        label { display: block; font-size: 12px; font-weight: 600; color: var(--text-light); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
        .req { color: var(--danger); margin-left: 2px; }

        /* ALL INPUTS CAPS */
        input, select {
            width: 100%; padding: 12px 14px;
            border-radius: 8px; border: 1px solid #cbd5e1;
            font-size: 14px; background: #f8fafc; color: #1e293b;
            transition: 0.2s;
            text-transform: uppercase; /* VISUAL CAPS */
        }
        input:focus, select:focus { border-color: var(--accent); background: white; outline: none; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        input::placeholder { text-transform: none; opacity: 0.6; }

        /* BUTTONS */
        .btn {
            width: 100%; padding: 14px; border-radius: 10px; border: none;
            font-size: 14px; font-weight: 700; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            text-transform: uppercase; letter-spacing: 0.5px;
            transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--accent); color: white; box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.4); }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-ghost { background: #e2e8f0; color: var(--text-main); }
        .btn-small { width: auto; padding: 8px 16px; font-size: 12px; }

        /* SECTOR GRID */
        .sector-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .toggle-card {
            background: #fff; border: 1px solid #e2e8f0; padding: 12px;
            border-radius: 8px; display: flex; align-items: center; justify-content: space-between;
        }
        .toggle-card label { margin: 0; cursor: pointer; color: var(--text-main); }
        input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--accent); }

        /* CUSTOM MODAL & WARNING */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(2px);
            z-index: 2000; display: none; align-items: center; justify-content: center;
        }
        .modal-box {
            background: white; width: 85%; max-width: 350px;
            border-radius: 16px; padding: 24px; text-align: center;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            max-height: 90vh; overflow-y: auto;
        }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* LIST STYLES */
        .record-card {
            background: white; border-radius: 12px; padding: 15px;
            margin-bottom: 10px; border: 1px solid #e2e8f0;
            display: flex; justify-content: space-between; align-items: center;
        }
        .record-card h5 { margin: 0; font-size: 15px; color: var(--primary); }
        .record-card p { margin: 2px 0 0; font-size: 12px; color: var(--text-light); }

        /* PREDICTIVE LIST */
        .pred-list {
            list-style: none; padding: 0; margin: 0; border: 1px solid #cbd5e1;
            border-top: none; max-height: 150px; overflow-y: auto;
            background: white; border-radius: 0 0 8px 8px;
            display: none; text-align: left;
        }
        .pred-item {
            padding: 10px; font-size: 13px; border-bottom: 1px solid #f1f5f9; cursor: pointer;
        }
        .pred-item:hover { background: #f8fafc; }

        /* PAGINATION */
        .pagination { display: flex; justify-content: center; gap: 10px; margin-top: 20px; }
        .page-btn { padding: 8px 12px; background: white; border: 1px solid #cbd5e1; border-radius: 6px; cursor: pointer; }
        .page-btn.disabled { opacity: 0.5; cursor: not-allowed; }

        .config-item { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #eee; font-size: 13px; }

        .hidden { display: none; }
    </style>
</head>
<body>

<div id="login-overlay" class="modal-overlay" style="display:flex; z-index:9999;">
    <div class="modal-box">
        <div style="color:var(--primary); font-size:40px; margin-bottom:10px;"><i class="fas fa-shield-alt"></i></div>
        <h3 style="margin:0; color:var(--primary);">SECURITY CHECK</h3>
        <p style="font-size:12px; color:#666; margin-bottom:20px;" id="login-msg">Enter System Password</p>
        <input type="password" id="login-pass" style="text-align:center; margin-bottom:15px;" placeholder="PASSWORD">
        <button class="btn btn-primary" onclick="attemptLogin()">UNLOCK SYSTEM</button>
        <div style="margin-top:15px; font-size:11px; cursor:pointer; color:var(--accent);" onclick="forgotPassword()">Reset Password</div>
    </div>
</div>

<div id="purok-warning-modal" class="modal-overlay">
    <div class="modal-box">
        <div style="color:var(--warning); font-size:40px; margin-bottom:10px;"><i class="fas fa-exclamation-triangle"></i></div>
        <h3 style="margin:0;">CHANGE ACTIVE PUROK?</h3>
        <p style="font-size:13px; color:#666; margin: 10px 0 20px 0;">
            This will change the Purok assignment for <b>ALL NEW ENTRIES</b>.<br>
            Current: <b id="warn-curr"></b> → New: <b id="warn-new"></b>
        </p>
        <div style="display:flex; gap:10px;">
            <button class="btn btn-ghost" onclick="cancelPurokChange()">CANCEL</button>
            <button class="btn btn-primary" onclick="confirmPurokChange()">CONFIRM</button>
        </div>
    </div>
</div>

<div id="hh-modal" class="modal-overlay">
    <div class="modal-box" style="width: 95%; max-width: 400px;">
        <h4 style="margin-top:0; color:var(--primary);">MANAGE HOUSEHOLD</h4>
        
        <div class="form-group" style="text-align:left;">
            <label>Household Number / ID</label>
            <input id="hh-id-input" placeholder="e.g., 2024-001">
        </div>

        <div style="text-align:left; margin-bottom:15px;">
            <label>Add Members (Search)</label>
            <input id="hh-member-search" oninput="searchMemberForHH()" placeholder="Type Name...">
            <ul id="hh-pred-list" class="pred-list"></ul>
        </div>

        <div style="text-align:left;">
            <label>Current Members:</label>
            <div id="hh-members-display" style="border:1px solid #eee; padding:10px; border-radius:8px; max-height:150px; overflow-y:auto; background:#f8fafc;">
                <small>No members added.</small>
            </div>
        </div>

        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn btn-ghost" onclick="closeHHModal()">CLOSE</button>
            <button class="btn btn-primary" onclick="saveHousehold()">SAVE HOUSEHOLD</button>
        </div>
    </div>
</div>

<div class="app-container">

    <div class="context-bar">
        <div class="context-info">
            <h4>RBI SYSTEM</h4>
            <small>SEC JERICK™</small>
        </div>
        <div class="purok-selector-btn" onclick="openPurokSelector()">
            <span>ACTIVE PUROK</span>
            <span class="purok-badge" id="globalPurokDisplay">1</span>
            <i class="fas fa-chevron-down" style="font-size:10px;"></i>
        </div>
    </div>

    <div class="tab-nav">
        <button class="tab-btn active" onclick="switchTab('reg')" id="btn-reg"><i class="fas fa-user-plus"></i> FORM</button>
        <button class="tab-btn" onclick="switchTab('rec')" id="btn-rec"><i class="fas fa-list"></i> RECORDS</button>
        <button class="tab-btn" onclick="switchTab('hh')" id="btn-hh"><i class="fas fa-home"></i> HOUSEHOLDS</button>
        <button class="tab-btn" onclick="switchTab('conf')" id="btn-conf"><i class="fas fa-cog"></i> CONFIG</button>
    </div>

    <div id="tab-registration" class="content-area">
        
        <div id="edit-banner" style="background:var(--warning); color:white; padding:10px; border-radius:8px; margin-bottom:15px; display:none; text-align:center; font-size:13px; font-weight:bold;">
            <i class="fas fa-edit"></i> EDITING RECORD - PUROK <span id="edit-purok-indicator"></span>
        </div>

        <div class="card-section">
            <h5 class="section-title">1. PERSONAL DATA</h5>
            
            <div class="form-group">
                <label>Inhabitant Type<span class="req">*</span></label>
                <select id="inhabitantType"><option>NON-MIGRANT</option><option>MIGRANT</option><option>TRANSIENT</option></select>
            </div>

            <div class="form-group"><label>Last Name<span class="req">*</span></label><input id="lastName" placeholder="DELA CRUZ"></div>
            <div class="form-group"><label>First Name<span class="req">*</span></label><input id="firstName" placeholder="JUAN"></div>
            <div class="form-group"><label>Middle Name</label><input id="middleName" placeholder="(OPTIONAL)"></div>
            <div class="form-group"><label>Suffix</label><input id="suffix" placeholder="JR, III (OPTIONAL)"></div>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <div class="form-group"><label>Birthday<span class="req">*</span></label><input type="date" id="birthDate"></div>
                <div class="form-group"><label>Sex<span class="req">*</span></label><select id="sex"><option>MALE</option><option>FEMALE</option></select></div>
            </div>

            <div class="form-group"><label>Birth Place<span class="req">*</span></label><input id="birthPlace"></div>
            <div class="form-group"><label>Civil Status<span class="req">*</span></label>
                <select id="civilStatus"><option>SINGLE</option><option>MARRIED</option><option>WIDOWED</option><option>SEPARATED</option><option>COMMON LAW/ LIVE-IN</option></select>
            </div>
            <div class="form-group"><label>Citizenship<span class="req">*</span></label><input id="citizenship" value="FILIPINO"></div>

            <div class="form-group">
                <label>Religion (Select/Type Other)<span class="req">*</span></label>
                <select id="religionSelect" onchange="checkReligion()">
                    <option value="ROMAN CATHOLIC">ROMAN CATHOLIC</option>
                    <option value="IGLESIA NI CRISTO">IGLESIA NI CRISTO</option>
                    <option value="ISLAM">ISLAM</option>
                    <option value="EVANGELICALS">EVANGELICALS</option>
                    <option value="BAPTIST">BAPTIST</option>
                    <option value="SEVENTH DAY ADVENTIST">SEVENTH DAY ADVENTIST</option>
                    <option value="AGLIPAYAN">AGLIPAYAN</option>
                    <option value="JEHOVAH'S WITNESS">JEHOVAH'S WITNESS</option>
                    <option value="OTHERS">OTHERS (PLEASE SPECIFY)</option>
                </select>
                <input id="religionOther" placeholder="TYPE RELIGION HERE..." style="display:none; margin-top:5px; border-color:var(--accent);">
            </div>
            
            <div class="form-group"><label>Profession / Occupation</label><input id="profession"></div>
        </div>

        <div class="card-section">
            <h5 class="section-title">2. ADDRESS & EDUCATION</h5>
            
            <div class="form-group">
                <label>Additional Address / Landmark<span class="req">*</span></label>
                <select id="addressSelect">
                    <option value="">SELECT ADDRESS...</option>
                </select>
                <small style="color:var(--accent); cursor:pointer;" onclick="switchTab('conf')"> + Manage Addresses in Config</small>
            </div>

            <div class="form-group"><label>Educational Attainment</label>
                <select id="education">
                    <option>NONE</option>
                    <option>ELEMENTARY LEVEL</option>
                    <option>ELEMENTARY GRADUATE</option>
                    <option>HIGH SCHOOL LEVEL</option>
                    <option>HIGH SCHOOL GRADUATE</option>
                    <option>SENIOR HIGH SCHOOL LEVEL</option>
                    <option>SENIOR HIGH SCHOOL GRADUATE</option>
                    <option>COLLEGE LEVEL</option>
                    <option>COLLEGE GRADUATE</option>
                    <option>VOCATIONAL</option>
                    <option>POST GRADUATE</option>
                </select>
            </div>

            <div class="form-group"><label>Contact Number</label><input id="contact" type="tel"></div>
        </div>

        <div class="card-section">
            <h5 class="section-title">3. SECTORAL MEMBERSHIP</h5>
            <div class="sector-grid">
                <div class="toggle-card"><label for="isOSY">OSY</label><input type="checkbox" id="isOSY"></div>
                <div class="toggle-card"><label for="isPWD">PWD</label><input type="checkbox" id="isPWD"></div>
                <div class="toggle-card"><label for="is4Ps">4Ps</label><input type="checkbox" id="is4Ps"></div>
                <div class="toggle-card"><label for="isIPS">IPs</label><input type="checkbox" id="isIPS"></div>
                <div class="toggle-card"><label for="isSolo">Solo Parent</label><input type="checkbox" id="isSolo"></div>
            </div>
        </div>

        <div class="card-section" style="background:#f8fafc; border:1px dashed #cbd5e1;">
            <h5 class="section-title" style="border-left-color:var(--primary);">4. MOTHER'S MAIDEN NAME</h5>
            <div class="form-group">
               <input id="motherSearch" list="motherList" onchange="autoFillMother(this)" placeholder="SEARCH EXISTING MOTHERS..." style="border-color:var(--accent);">
               <datalist id="motherList"></datalist>
            </div>
            <div class="form-group"><input id="mFirst" placeholder="MOTHER'S FIRST NAME"></div>
            <div class="form-group"><input id="mMiddle" placeholder="MOTHER'S MIDDLE NAME"></div>
            <div class="form-group"><input id="mLast" placeholder="MOTHER'S LAST NAME"></div>
        </div>

        <div style="display:flex; gap:10px; margin-top:20px;">
            <button id="btn-cancel" class="btn btn-danger" onclick="cancelEdit()" style="display:none;">CANCEL EDIT</button>
            <button id="btn-save" class="btn btn-primary" onclick="saveRecord()"><i class="fas fa-save"></i> SAVE RECORD</button>
        </div>
    </div>

    <div id="tab-records" class="content-area hidden">
        <div class="form-group">
            <input id="searchBox" oninput="renderList()" placeholder="SEARCH BY NAME..." style="box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);">
        </div>
        <div id="resultList" style="margin-top:15px;"></div>
        
        <div class="card-section" style="margin-top:20px; text-align:center;">
            <button class="btn btn-success" onclick="exportExcel()"><i class="fas fa-file-excel"></i> EXPORT TO EXCEL</button>
        </div>
    </div>

    <div id="tab-households" class="content-area hidden">
        <div style="display:flex; gap:10px; margin-bottom:15px;">
            <input id="searchHH" oninput="renderHouseholdList()" placeholder="Search Household or Member..." style="flex:1;">
            <button class="btn btn-primary" style="width:auto;" onclick="openHHModal()"><i class="fas fa-plus"></i></button>
        </div>
        
        <div id="hh-list-container"></div>
        
        <div class="pagination">
            <button id="btn-prev-hh" class="page-btn" onclick="changeHHPage(-1)">Prev</button>
            <span id="hh-page-indicator" style="align-self:center; font-size:12px;">Page 1</span>
            <button id="btn-next-hh" class="page-btn" onclick="changeHHPage(1)">Next</button>
        </div>
    </div>

    <div id="tab-config" class="content-area hidden">
        <div class="card-section">
            <h5 class="section-title">SYSTEM CONFIGURATION</h5>
            
            <div class="form-group">
                <label>Set Maximum Purok Number</label>
                <div style="display:flex; gap:10px;">
                    <input type="number" id="confPurok" placeholder="Default: 10">
                    <button class="btn btn-primary" style="width:auto;" onclick="savePurokConf()">UPDATE</button>
                </div>
            </div>

            <div class="form-group" style="margin-top:20px;">
                <label>Manage Additional Addresses</label>
                <div style="display:flex; gap:5px;">
                    <input id="newAddress" placeholder="e.g. UPPER BASAK">
                    <button class="btn btn-small btn-success" onclick="addAddress()">ADD</button>
                </div>
                <div class="list" id="listAddresses" style="max-height:150px; margin-top:10px;"></div>
            </div>
            
            <hr style="border:0; border-top:1px solid #eee; margin:20px 0;">
            
            <div class="form-group">
                 <label>Admin Password Management</label>
                 <button class="btn btn-ghost" onclick="forgotPassword()">Reset Admin Password</button>
            </div>
        </div>
    </div>

</div>

<input type="hidden" id="tempPurokTarget">

<div id="viewer-overlay" class="modal-overlay" onclick="if(event.target===this) closeViewer()">
    <div class="viewer-card" style="background:white; width:100%; max-width:500px; height:90vh; border-radius:20px 20px 0 0; position:absolute; bottom:0; padding:20px; overflow-y:auto; animation: slideUp 0.3s;">
        <h3 style="color:var(--primary); border-bottom:2px solid var(--accent); padding-bottom:10px; margin-bottom:15px;">RECORD DETAILS</h3>
        <div id="viewer-content"></div>
        <div id="viewer-actions" style="margin-top:20px; display:flex; flex-direction:column; gap:10px;"></div>
    </div>
</div>

<style> @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } } </style>

<script>
// --- CONFIGURATION ---
const HEADERS = [
    "INHABITANT TYPE", "LAST NAME", "FIRST NAME", "MIDDLE NAME", "SUFFIX", 
    "BIRTH PLACE", "BIRTHDATE (YYYY-MM-DD)", "SEX", "CIVIL STATUS", "CITIZENSHIP", 
    "PROFESSION/ OCCUPATION", "CONTACT NUMBER", "EMAIL ADDRESS", 
    "HIGHEST EDUCATIONAL ATTAINMENT", "MOTHER'S FIRST NAME", 
    "MOTHER'S MIDDLE NAME", "MOTHER'S LAST NAME",
    "PUROK", "ADDITIONAL ADDRESS", "RELIGION", 
    "IS OSY", "IS PWD", "IS 4Ps", "IS IPS", "IS SOLO PARENT"
];

let records = JSON.parse(localStorage.getItem('rbiRecords')) || [];
let households = JSON.parse(localStorage.getItem('rbiHouseholds')) || [];
let settings = JSON.parse(localStorage.getItem('rbi_settings')) || { 
    custom_password: '', 
    purok_max: 10,
    addresses: []
};

// Global State
let currentGlobalPurok = localStorage.getItem('globalPurok') || "1";
let editingIndex = -1; 
let hhPage = 1;
let currentEditingHH = null; // Object for HH edit
let tempHHMembers = []; // Indices of members in current HH edit session

// --- SECURITY LOGIC ---
function getDynamicPassword() {
    const now = new Date();
    const y = now.getFullYear();
    const onejan = new Date(y, 0, 1);
    const w = Math.ceil((((now - onejan) / 86400000) + onejan.getDay() + 1) / 7);
    return `RBI-${now.getMonth()}${now.getDate()}${y}${w*2}`;
}

window.onload = function() {
    if(!settings.custom_password) {
        document.getElementById('login-msg').innerText = "Create Your Password to Start";
    }
    updateMotherDatalist(); 
    loadConfigUI();
    updateGlobalPurokUI();
}

function attemptLogin() {
    const input = document.getElementById('login-pass').value;
    if (!settings.custom_password) {
        if(input.trim().length > 0) {
            settings.custom_password = input.trim();
            saveSettings();
            alert("Password Set! Logged in.");
            document.getElementById('login-overlay').style.display = 'none';
        } else alert("Create a password.");
        return;
    }
    if (input === settings.custom_password) {
        document.getElementById('login-overlay').style.display = 'none';
    } else alert("Incorrect Password.");
}

function forgotPassword() {
    const input = prompt("Enter Dynamic Admin Password:");
    if(input === getDynamicPassword()) {
        const newPass = prompt("Admin Code Correct. Enter NEW Password:");
        if(newPass && newPass.trim().length > 0) { 
            settings.custom_password = newPass.trim(); 
            saveSettings(); 
            alert("Password Reset Successfully."); 
        }
    } else if(input) alert("Invalid Code.");
}

function saveSettings() { localStorage.setItem('rbi_settings', JSON.stringify(settings)); }

// --- GLOBAL PUROK LOGIC ---
function updateGlobalPurokUI() {
    document.getElementById('globalPurokDisplay').innerText = currentGlobalPurok;
    localStorage.setItem('globalPurok', currentGlobalPurok);
}

function openPurokSelector() {
    const max = settings.purok_max || 10;
    const input = prompt(`Enter Purok Number (1-${max}):`, currentGlobalPurok);
    if(input && parseInt(input) >= 1 && parseInt(input) <= max && input !== currentGlobalPurok) {
        document.getElementById('tempPurokTarget').value = input;
        document.getElementById('warn-curr').innerText = currentGlobalPurok;
        document.getElementById('warn-new').innerText = input;
        document.getElementById('purok-warning-modal').style.display = 'flex';
    }
}

function confirmPurokChange() {
    currentGlobalPurok = document.getElementById('tempPurokTarget').value;
    updateGlobalPurokUI();
    document.getElementById('purok-warning-modal').style.display = 'none';
}

function cancelPurokChange() { document.getElementById('purok-warning-modal').style.display = 'none'; }

// --- CONFIG TAB ---
function loadConfigUI() {
    const pMax = settings.purok_max || 10;
    document.getElementById('confPurok').value = pMax;
    
    // Populate Address Dropdown in Form
    const sel = document.getElementById('addressSelect');
    sel.innerHTML = '<option value="">SELECT ADDRESS...</option>';
    (settings.addresses || []).forEach(addr => {
        let opt = document.createElement('option');
        opt.value = addr;
        opt.innerText = addr;
        sel.appendChild(opt);
    });

    // Populate Address List in Config
    const list = document.getElementById('listAddresses');
    list.innerHTML = '';
    (settings.addresses || []).forEach((addr, i) => {
        list.innerHTML += `<div class="config-item"><span>${addr}</span> <i class="fas fa-trash" style="color:red; cursor:pointer;" onclick="removeAddress(${i})"></i></div>`;
    });
}

function savePurokConf() {
    const val = parseInt(document.getElementById('confPurok').value);
    if(val > 0) { settings.purok_max = val; saveSettings(); alert("Purok Limit Updated"); }
}

function addAddress() {
    const val = document.getElementById('newAddress').value.toUpperCase().trim();
    if(val) {
        if(!settings.addresses) settings.addresses = [];
        settings.addresses.push(val);
        saveSettings();
        document.getElementById('newAddress').value = "";
        loadConfigUI();
    }
}

function removeAddress(i) {
    if(confirm("Remove this address option?")) {
        settings.addresses.splice(i, 1);
        saveSettings();
        loadConfigUI();
    }
}

// --- TAB SWITCHING ---
function switchTab(tab) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.content-area').forEach(c => c.classList.add('hidden'));

    if(tab === 'reg') {
        document.getElementById('tab-registration').classList.remove('hidden');
        document.getElementById('btn-reg').classList.add('active');
    } else if(tab === 'rec') {
        document.getElementById('tab-records').classList.remove('hidden');
        document.getElementById('btn-rec').classList.add('active');
        renderList();
    } else if (tab === 'hh') {
        document.getElementById('tab-households').classList.remove('hidden');
        document.getElementById('btn-hh').classList.add('active');
        renderHouseholdList();
    } else if (tab === 'conf') {
        document.getElementById('tab-config').classList.remove('hidden');
        document.getElementById('btn-conf').classList.add('active');
    }
}

// --- RELIGION ---
function checkReligion() {
    const sel = document.getElementById('religionSelect');
    const otherInp = document.getElementById('religionOther');
    otherInp.style.display = (sel.value === 'OTHERS') ? 'block' : 'none';
}

// --- SAVE RECORD ---
function saveRecord(){
  const idsToCheck = ['lastName', 'firstName', 'birthPlace', 'birthDate', 'citizenship', 'addressSelect'];
  
  for(let id of idsToCheck) {
      if(!document.getElementById(id).value.trim()) {
          alert("FIELD REQUIRED: " + id.replace(/([A-Z])/g, ' $1').toUpperCase());
          return;
      }
  }
  
  let finalReligion = document.getElementById('religionSelect').value;
  if(finalReligion === 'OTHERS') {
      finalReligion = document.getElementById('religionOther').value.toUpperCase();
      if(!finalReligion) { alert("PLEASE SPECIFY RELIGION"); return; }
  }

  let purokToSave = currentGlobalPurok;
  if(editingIndex > -1) purokToSave = records[editingIndex][17]; 

  const newRow = [
    document.getElementById('inhabitantType').value,
    document.getElementById('lastName').value.toUpperCase(),
    document.getElementById('firstName').value.toUpperCase(),
    document.getElementById('middleName').value.toUpperCase(),
    document.getElementById('suffix').value.toUpperCase(), 
    document.getElementById('birthPlace').value.toUpperCase(),
    document.getElementById('birthDate').value,
    document.getElementById('sex').value,
    document.getElementById('civilStatus').value,
    document.getElementById('citizenship').value.toUpperCase(),
    document.getElementById('profession').value.toUpperCase(), 
    document.getElementById('contact').value, 
    "", 
    document.getElementById('education').value,
    document.getElementById('mFirst').value.toUpperCase(),
    document.getElementById('mMiddle').value.toUpperCase(),
    document.getElementById('mLast').value.toUpperCase(),
    purokToSave, 
    document.getElementById('addressSelect').value, 
    finalReligion, 
    document.getElementById('isOSY').checked ? "YES" : "NO",
    document.getElementById('isPWD').checked ? "YES" : "NO",
    document.getElementById('is4Ps').checked ? "YES" : "NO",
    document.getElementById('isIPS').checked ? "YES" : "NO",
    document.getElementById('isSolo').checked ? "YES" : "NO"
  ];

  if (editingIndex > -1) {
      records[editingIndex] = newRow;
      alert('RECORD UPDATED!');
      cancelEdit(); 
  } else {
      records.push(newRow);
      alert('RECORD SAVED TO PUROK ' + purokToSave);
  }

  localStorage.setItem('rbiRecords', JSON.stringify(records));
  updateMotherDatalist();

  if(editingIndex === -1) {
      const currType = document.getElementById('inhabitantType').value;
      const currRel = "ROMAN CATHOLIC"; 
      document.querySelectorAll('input').forEach(i => {
          if(i.type === 'checkbox') i.checked = false;
          else i.value = '';
      });
      document.getElementById('inhabitantType').value = currType;
      document.getElementById('citizenship').value = "FILIPINO";
      document.getElementById('religionSelect').value = currRel;
      document.getElementById('addressSelect').value = "";
      checkReligion();
      document.getElementById('lastName').focus();
  }
}

// --- EDITING ---
function startEdit(index) {
    const r = records[index];
    document.getElementById('inhabitantType').value = r[0];
    document.getElementById('lastName').value = r[1];
    document.getElementById('firstName').value = r[2];
    document.getElementById('middleName').value = r[3];
    document.getElementById('suffix').value = r[4];
    document.getElementById('birthPlace').value = r[5];
    document.getElementById('birthDate').value = r[6];
    document.getElementById('sex').value = r[7];
    document.getElementById('civilStatus').value = r[8];
    document.getElementById('citizenship').value = r[9];
    document.getElementById('profession').value = r[10];
    document.getElementById('contact').value = r[11];
    document.getElementById('education').value = r[13];
    document.getElementById('mFirst').value = r[14];
    document.getElementById('mMiddle').value = r[15];
    document.getElementById('mLast').value = r[16];
    
    // Set Dropdown
    document.getElementById('addressSelect').value = r[18];

    const relVal = r[19] || "ROMAN CATHOLIC";
    const relSelect = document.getElementById('religionSelect');
    let exists = false;
    for(let i=0; i<relSelect.options.length; i++) if(relSelect.options[i].value === relVal) exists = true;
    
    if(exists) {
        relSelect.value = relVal;
        document.getElementById('religionOther').style.display = 'none';
    } else {
        relSelect.value = 'OTHERS';
        document.getElementById('religionOther').style.display = 'block';
        document.getElementById('religionOther').value = relVal;
    }

    document.getElementById('isOSY').checked = (r[20] === "YES");
    document.getElementById('isPWD').checked = (r[21] === "YES");
    document.getElementById('is4Ps').checked = (r[22] === "YES");
    document.getElementById('isIPS').checked = (r[23] === "YES");
    document.getElementById('isSolo').checked = (r[24] === "YES");

    editingIndex = index;
    
    document.getElementById('btn-save').innerHTML = '<i class="fas fa-check"></i> UPDATE RECORD';
    document.getElementById('btn-cancel').style.display = "flex";
    document.getElementById('edit-banner').style.display = "block";
    document.getElementById('edit-purok-indicator').innerText = r[17];
    
    closeViewer();
    switchTab('reg');
}

function cancelEdit() {
    editingIndex = -1;
    document.getElementById('btn-save').innerHTML = '<i class="fas fa-save"></i> SAVE RECORD';
    document.getElementById('btn-cancel').style.display = "none";
    document.getElementById('edit-banner').style.display = "none";
    
    document.querySelectorAll('input').forEach(i => {
        if(i.type === 'checkbox') i.checked = false;
        else i.value = '';
    });
    document.getElementById('addressSelect').value = "";
    document.getElementById('citizenship').value = "FILIPINO";
    document.getElementById('religionSelect').value = "ROMAN CATHOLIC";
    checkReligion();
}

// --- RECORDS SEARCH ---
function renderList(){
  const q = document.getElementById('searchBox').value.toLowerCase();
  const list = document.getElementById('resultList');
  list.innerHTML = '';
  
  const filtered = records.map((r, i) => ({data: r, index: i}))
    .filter(item => item.data[1].toLowerCase().includes(q) || item.data[2].toLowerCase().includes(q));
  
  if(filtered.length === 0) {
      list.innerHTML = '<div style="text-align:center; padding:20px; color:#94a3b8;">NO RECORDS FOUND</div>';
      return;
  }

  filtered.forEach((item) => {
    const r = item.data;
    const div = document.createElement('div');
    div.className = 'record-card';
    div.onclick = () => viewRecord(item.index); 
    div.innerHTML = `
        <div>
            <h5>${r[1]}, ${r[2]} ${r[4]}</h5>
            <p>PUROK ${r[17]} | ${r[18] || 'NO ADDR'}</p>
        </div>
        <i class="fas fa-chevron-right" style="color:var(--accent);"></i>
    `;
    list.appendChild(div);
  });
}

function viewRecord(index) {
    const r = records[index];
    const html = HEADERS.map((h, i) => `
        <div style="border-bottom:1px solid #eee; padding:8px 0;">
            <span style="font-size:10px; color:#94a3b8; display:block;">${h}</span>
            <span style="font-size:14px; font-weight:600; color:#334155;">${r[i] || '-'}</span>
        </div>
    `).join('');
    
    document.getElementById('viewer-content').innerHTML = html;
    document.getElementById('viewer-actions').innerHTML = `
        <button class="btn btn-warning" onclick="startEdit(${index})" style="background:#f59e0b; color:white;">EDIT RECORD</button>
        <button class="btn btn-ghost" onclick="closeViewer()">CLOSE</button>
    `;
    document.getElementById('viewer-overlay').style.display = 'flex';
}

function closeViewer() { document.getElementById('viewer-overlay').style.display = 'none'; }

// --- HOUSEHOLD LOGIC ---
function openHHModal(index = -1) {
    document.getElementById('hh-modal').style.display = 'flex';
    document.getElementById('hh-pred-list').style.display = 'none';
    document.getElementById('hh-member-search').value = '';
    
    if(index > -1) {
        // Edit Mode
        currentEditingHH = households[index];
        tempHHMembers = [...currentEditingHH.members]; // copy array
        document.getElementById('hh-id-input').value = currentEditingHH.id;
    } else {
        // New Mode
        currentEditingHH = null;
        tempHHMembers = [];
        document.getElementById('hh-id-input').value = "";
    }
    renderHHMembersPreview();
}

function closeHHModal() {
    document.getElementById('hh-modal').style.display = 'none';
}

function searchMemberForHH() {
    const val = document.getElementById('hh-member-search').value.toLowerCase();
    const list = document.getElementById('hh-pred-list');
    list.innerHTML = '';
    
    if(val.length < 2) { list.style.display = 'none'; return; }

    const matches = records.map((r, i) => ({name: `${r[1]}, ${r[2]}`, index: i}))
                         .filter(m => m.name.toLowerCase().includes(val));
    
    if(matches.length > 0) {
        list.style.display = 'block';
        matches.slice(0, 5).forEach(m => {
            const li = document.createElement('li');
            li.className = 'pred-item';
            li.innerText = m.name;
            li.onclick = () => addMemberToHH(m.index);
            list.appendChild(li);
        });
    } else {
        list.style.display = 'none';
    }
}

function addMemberToHH(recordIndex) {
    if(!tempHHMembers.includes(recordIndex)) {
        tempHHMembers.push(recordIndex);
        renderHHMembersPreview();
        document.getElementById('hh-member-search').value = '';
        document.getElementById('hh-pred-list').style.display = 'none';
    } else {
        alert("Person already in this list.");
    }
}

function removeMemberFromHH(tempIndex) {
    tempHHMembers.splice(tempIndex, 1);
    renderHHMembersPreview();
}

function renderHHMembersPreview() {
    const div = document.getElementById('hh-members-display');
    div.innerHTML = '';
    if(tempHHMembers.length === 0) { div.innerHTML = '<small>No members added.</small>'; return; }
    
    tempHHMembers.forEach((recIdx, i) => {
        const r = records[recIdx];
        if(r) {
            div.innerHTML += `
            <div style="display:flex; justify-content:space-between; margin-bottom:5px; border-bottom:1px solid #ddd; padding-bottom:5px;">
                <span>${r[1]}, ${r[2]}</span>
                <i class="fas fa-times" style="color:red; cursor:pointer;" onclick="removeMemberFromHH(${i})"></i>
            </div>`;
        }
    });
}

function saveHousehold() {
    const hhID = document.getElementById('hh-id-input').value.trim();
    if(!hhID) { alert("Household Number required"); return; }
    if(tempHHMembers.length === 0) { alert("Add at least one member"); return; }

    if(currentEditingHH) {
        // Update
        currentEditingHH.id = hhID;
        currentEditingHH.members = tempHHMembers;
        alert("Household Updated");
    } else {
        // Create
        households.push({ id: hhID, members: tempHHMembers });
        alert("Household Created");
    }
    
    localStorage.setItem('rbiHouseholds', JSON.stringify(households));
    closeHHModal();
    renderHouseholdList();
}

function renderHouseholdList() {
    const container = document.getElementById('hh-list-container');
    const search = document.getElementById('searchHH').value.toLowerCase();
    container.innerHTML = '';
    
    // Filter first
    let filtered = households.filter(hh => {
        if(hh.id.toLowerCase().includes(search)) return true;
        // Search members inside
        return hh.members.some(idx => {
            const r = records[idx];
            return r && (r[1].toLowerCase().includes(search) || r[2].toLowerCase().includes(search));
        });
    });

    // Pagination Logic
    const itemsPerPage = 5;
    const totalPages = Math.ceil(filtered.length / itemsPerPage) || 1;
    if(hhPage > totalPages) hhPage = totalPages;
    if(hhPage < 1) hhPage = 1;
    
    document.getElementById('hh-page-indicator').innerText = `Page ${hhPage} of ${totalPages}`;
    document.getElementById('btn-prev-hh').className = `page-btn ${hhPage===1?'disabled':''}`;
    document.getElementById('btn-next-hh').className = `page-btn ${hhPage===totalPages?'disabled':''}`;

    const start = (hhPage - 1) * itemsPerPage;
    const end = start + itemsPerPage;
    const pageItems = filtered.slice(start, end);

    if(pageItems.length === 0) {
        container.innerHTML = '<div style="text-align:center; padding:20px;">No Households Found</div>';
        return;
    }

    pageItems.forEach(hh => {
        // Find actual index in main array for editing
        const realIndex = households.indexOf(hh);
        const headIdx = hh.members[0];
        const headName = records[headIdx] ? `${records[headIdx][1]}, ${records[headIdx][2]}` : "Unknown";
        
        const div = document.createElement('div');
        div.className = 'record-card';
        div.onclick = () => openHHModal(realIndex);
        div.innerHTML = `
            <div>
                <h5 style="color:var(--accent);">HH: ${hh.id}</h5>
                <p><b>Head:</b> ${headName}</p>
                <p style="font-size:11px;">Members: ${hh.members.length}</p>
            </div>
            <i class="fas fa-pencil-alt" style="color:var(--text-light);"></i>
        `;
        container.appendChild(div);
    });
}

function changeHHPage(dir) {
    hhPage += dir;
    renderHouseholdList();
}

// --- UTILS ---
function updateMotherDatalist() {
    const dl = document.getElementById('motherList');
    dl.innerHTML = '';
    const uniqueMothers = new Set();
    records.forEach(r => {
        if(r[16] && r[14]) {
            const motherKey = `${r[16]}, ${r[14]}`;
            if(!uniqueMothers.has(motherKey)){
                uniqueMothers.add(motherKey);
                const option = document.createElement('option');
                option.value = `${r[16]}, ${r[14]} ${r[15] || ''}`.trim(); 
                dl.appendChild(option);
            }
        }
    });
}
function autoFillMother(inputObj) {
    const val = inputObj.value;
    const found = records.find(r => `${r[16]}, ${r[14]} ${r[15] || ''}`.trim() === val);
    if(found) {
        document.getElementById('mLast').value = found[16];
        document.getElementById('mFirst').value = found[14];
        document.getElementById('mMiddle').value = found[15];
    }
}

function exportExcel(){
  if(records.length === 0){ alert("No records to export."); return; }
  const wb = XLSX.utils.book_new();
  const instructionData = [["INSTRUCTIONS"], ["Generated by SEC JERICK RBI System"], ["See 'DATA' sheet."]];
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(instructionData), "INSTRUCTIONS");
  const allData = [HEADERS, ...records];
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(allData), "DATA");
  XLSX.writeFile(wb, `RBI_Export_${new Date().toISOString().slice(0,10)}.xlsx`);
}
</script>
</body>
</html>
